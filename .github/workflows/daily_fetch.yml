name: ðŸ« å¹¼å„¿å›­å•†æœºæ¯æ—¥è¿½è¸ª

on:
  schedule:
    # åŒ—äº¬æ—¶é—´æ¯å¤©ä¸Šåˆ9:00 = UTC 01:00
    - cron: '0 1 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'æ¼”ä¹ æ¨¡å¼ï¼ˆä¸å†™å…¥æ•°æ®ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      debug_mode:
        description: 'è°ƒè¯•æ¨¡å¼'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  fetch-and-notify:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ”§ åˆ›å»ºå‡­è¯æ–‡ä»¶
        run: |
          echo '${{ secrets.GOOGLE_CREDENTIALS }}' > credentials.json
      
      - name: ðŸš€ è¿è¡Œå•†æœºè¿½è¸ªç³»ç»Ÿ
        env:
          # Google Sheets
          GOOGLE_SHEET_NAME: ${{ secrets.GOOGLE_SHEET_NAME }}
          GOOGLE_SHEET_URL: ${{ secrets.GOOGLE_SHEET_URL }}
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          GOOGLE_CREDENTIALS_PATH: credentials.json
          
          # PushPlus
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          PUSHPLUS_TOPIC: ${{ secrets.PUSHPLUS_TOPIC }}
          
          # é’‰é’‰
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
          
          # Claude AI
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_MODEL: claude-sonnet-4-20250514
          
          # é€šçŸ¥ç­–ç•¥
          CRITICAL_THRESHOLD: '90'
          HIGH_THRESHOLD: '85'
          MEDIUM_THRESHOLD: '70'
          ENABLE_PUSHPLUS: 'true'
          ENABLE_DINGTALK: 'true'
          ENABLE_INSTANT_ALERTS: 'true'
          ENABLE_SOUND_ALERTS: 'true'
          ENABLE_CLAUDE_AI: 'true'
          
          # æ•°æ®æºé…ç½®
          ENABLED_SOURCES: 'ontario,acecqa'
          FETCH_TIMEOUT: '30'
          MAX_RETRIES: '3'
          
          # è¿è¡Œæ¨¡å¼
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
          LOG_LEVEL: 'INFO'
          
          # å…¶ä»–é…ç½®
          TIMEZONE: 'Asia/Shanghai'
          MAX_RECORDS_PER_RUN: '100'
          
        run: |
          cd src
          python main.py
      
      - name: ðŸ“„ ä¸Šä¼ è¿è¡Œæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.run_number }}-${{ github.run_attempt }}
          path: logs/
          retention-days: 30
          if-no-files-found: ignore
      
      - name: ðŸ§¹ æ¸…ç†å‡­è¯æ–‡ä»¶
        if: always()
        run: |
          rm -f credentials.json
      
      - name: ðŸ“Š è¾“å‡ºè¿è¡Œæ‘˜è¦
        if: success()
        run: |
          echo "## âœ… è¿è¡ŒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ¼”ä¹ æ¨¡å¼**: ${{ github.event.inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
      
      - name: âŒ å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "## âŒ è¿è¡Œå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æ£€æŸ¥æ—¥å¿—èŽ·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
